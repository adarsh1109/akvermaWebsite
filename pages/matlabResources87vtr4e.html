<!DOCTYPE html>
<html>

<head>
   <!-- basic -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- mobile metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta name="viewport" content="initial-scale=1, maximum-scale=1">
   <!-- site metas -->
   <title>Adarsh K. Verma</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
   <meta name="author" content="">
   <!-- bootstrap css -->
   <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
   <!-- style css -->
   <link rel="stylesheet" type="text/css" href="css/style.css">
   <!-- Responsive-->
   <link rel="stylesheet" href="css/responsive.css">
   <!-- fevicon -->
   <!-- <link rel="icon" href="images/fevicon.png" type="image/gif" /> -->
   <!-- font css -->
   <link
      href="https://fonts.googleapis.com/css2?family=Philosopher:ital,wght@0,400;0,700;1,400;1,700&family=Poppins:wght@400;700&display=swap"
      rel="stylesheet">
   <!-- Scrollbar Custom CSS -->
   <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
   <!-- Tweaks for older IEs-->
   <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
</head>

<body>
   <div class="header_section">
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
         <!-- <a class="navbar-brand" href="index.html"><img src="images/logo.png"></a> -->
         <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
         </button>
         <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
               <li class="nav-item active">
                  <a class="nav-link" href="index.html">Home</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="academics.html">Academics</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="trainingAndExperience.html">Training & Experience</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="publications.html">Research & Publications</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="awardsAndPositions.html">Awards & Positions</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="pmrfProgress.html">PMRF Progress</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="contact.html">Contact</a>
               </li>
            </ul>

         </div>
      </nav>



      <!-- ICONS-->

      <style>
         /* Define your fixed icons */
         .fixed-icons {
            position: fixed;
            top: 80%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 999;
            /* Ensure icons appear above other elements */
         }

         /* Style your icons as needed */
         .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            cursor: pointer;
         }
      </style>
      <!-- icons -->
      <div class="like-icon fixed-icons">

         <a href="https://orcid.org/0000-0003-0249-6989" target="_blank" class=" icon"
            style="font-size:48px;text-decoration:none;">
            <img src="images/icon1.png" alt="ORCID" style="color:#fff;">
         </a>

         <a href="https://www.researchgate.net/profile/Adarsh-Verma-7" class="bg-dark icon" target="_blank"
            style="background-color:#000;font-size:48px;text-decoration:none;">
            <img src="images/icon2.png" alt="ResearchGate" style="color:#fff;">
         </a>

         <a href="https://www.linkedin.com/in/adarsh-k-verma-a05315211/" target="_blank" class=" icon"
            style="font-size:48px;text-decoration:none;">
            <img src="images/icon3.png" alt="LinkedIN" style="color:#fff;">
         </a>

      </div>









      <style>
         .two-column-list {
            display: flex;
            flex-direction: column;
            list-style-type: none;
            padding: 0;
            margin: auto;
            /* Add this line to center the element */
            max-width: 950px;
            /* Adjust the max-width as needed */
         }


         .row {
            display: flex;
            flex-direction: row;
            padding: 10px 0;
            /* Increase vertical padding between rows */
         }

         .ongoing_study {
            width: 100%;
            font-size: 40px;
            color: #2b2b2a;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
         }

         .ongoing_study_PMRFtitle {
            width: 100%;
            font-size: 28px;
            color: #2b2b2a;
            text-align: center;
            margin-bottom: 85px;
            padding-top: 40px;
         }

         .entry1 {
            flex: 1;
            text-align: left;
            font-size: 16px;
            max-width: 1000px;
            padding: 40 15px;
            margin-left: 30px;
            margin-left: -1em;
            padding-top: 30px;
            /* Set maximum width for the columns */
         }

         .entry2 {
            flex: 1;
            text-align: left;
            font-size: 16px;
            max-width: 1000px;
            padding: 40 15px;
            margin-left: 50px;
            /* Set maximum width for the columns */
         }



         .blog_section {
            text-align: center;
            /* Center the content in the blog section */
         }
      </style>

      <!-- Phase 1 start -->
      <div class="blog_section layout_padding">
         <div class="container">
            <div class="row">
               <div class="col-md-12">
                  
                  <h1 class="ongoing_study_PMRFtitle"><b>MATLAB Resources</b></h1>

                  
        <div>
         <h3><strong>EEG Preprocessing</strong></h3>
      </div>
      
      <p>
         <ul>
            <pre class="r-code">
[ALLEEG EEG CURRENTSET ALLCOM] = eeglab; close;
subjectName = 'G01S001'

subjectRawDataFolder = [parent_Directory, 'Raw_Data/', subjectName,'/'];

[subjectProcessingDirectory,processedDatasets,eventsFolder,plotsFolder,csvTxtMatFiles,excelHist,...
    ERPsScalpPlots, ERPsLinePlots, PowerTFPlots, PowerScalpPlots, chanlocfile] = makeFolders(parent_Directory,subjectName);

% read behavioral data file for event manipulation
behavioralDataFilePath = [experiment_Directory, 'AAT_Behavioral_Data/AAT_Compiled_Results/', subjectName, '/',subjectName '.csv'];
behavioralDataTable = readtable(behavioralDataFilePath,'ReadVariableNames', true,'Delimiter',',');

% INITIAL READING OF INPUT PARAMETERS
tempName = [subjectName, '_000_Initial'];

%% Import BrainProducts Data

vhdrFile = [subjectName, '.vhdr'];
EEG = pop_loadbv(subjectRawDataFolder,vhdrFile);
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
[ALLEEG, EEG, CURRENTSET] = eeg_store( ALLEEG, EEG);
EEG = eeg_checkset( EEG );
% EEG = pop_saveset(EEG, 'filename', [tempName, '.set'], 'filepath', processedDatasets);
[ALLEEG, EEG, CURRENTSET] = eeg_store( ALLEEG, EEG);

%% Import Emotiv Data

% % Loading Emotiv .edf file
% path_to_data = 'existing_data.edf';
% % Import the EDF data into EEGLAB
% EEG = pop_biosig(path_to_data);
%
% EEG.setname='EEGdatasetDemo';
% [ALLEEG, EEG, CURRENTSET] = eeg_store( ALLEEG, EEG);
% EEG = eeg_checkset( EEG );
% pop_eegplot( EEG, 1, 1, 1);
% eeglab redraw;


%% Downsample data, figh/low-pass filter, and import channel locations
tempName = [subjectName, '_Downsampled'];
% run([codepath,'readInputParameters.m']);


desiredSamplingRate=1000;


EEG = pop_resample( EEG, desiredSamplingRate);
[ALLEEG EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);
EEG.comments = pop_comments(EEG.comments,'','Dataset is resampled.',1);% add comment
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
% EEG = pop_saveset(EEG, 'filename', [tempName, '.set'], 'filepath', processedDatasets);
EEG = eeg_checkset( EEG );

%% Add channel locations
tempName = [subjectName, '_chanLocUpdated'];
% run([codepath,'readInputParameters.m']);

chanLocPath='/Users/adarshk.verma/Documents/GitHubRepo/Experiments.nosync/01_AAT_Experiment/AAT_EEG_datasets/NewAnalysisScript/';


% Load 64-channel locations
chanlocfile64 = [chanLocPath 'BP64ChanLoc.elp'];
EEG = pop_chanedit(EEG, 'lookup', chanlocfile64);
EEG = eeg_checkset(EEG);

% Save the updated EEG structure
EEG.comments = pop_comments(EEG.comments, '', 'Updated channel locations.', 1);
[ALLEEG, EEG, CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET, 'setname', tempName, 'gui', 'off');
EEG = eeg_checkset(EEG);
[ALLEEG, EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);


%% clear line noise (50Hz)
tempName = [subjectName, '_RemovedLineNoise'];

EEG = pop_cleanline(EEG, 'bandwidth',2,'chanlist',[1:EEG.nbchan] ,'computepower',1,'linefreqs',[50],'newversion',0,'normSpectrum',0,'p',0.01,'pad',2,'plotfigures',0,'scanforlines',0,'sigtype','Channels','taperbandwidth',2,'tau',100,'verb',1,'winsize',4,'winstep',1);
EEG.comments = pop_comments(EEG.comments,'','Removed Line Noise (50 Hz).',1);
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
[ALLEEG EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);
EEG = eeg_checkset( EEG );



%% *High/Low Pass Filter*

lo_freq = 0.1; % Lower cutoff frequency in Hz
hi_freq = 45; % Higher cutoff frequency in Hz


tempName = [subjectName, '_BandPass'];

EEG  = pop_basicfilter( EEG,  1:EEG.nbchan , 'Boundary', 'boundary', 'Cutoff', [ lo_freq hi_freq], 'Design', 'butter', 'Filter', 'bandpass', 'Order',  2 ); %
EEG.comments = pop_comments(EEG.comments,'','Dataset was filtered for low and high band pass.',1);
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
[ALLEEG EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);
EEG = eeg_checkset( EEG );
%     EEG = pop_saveset(EEG, 'filename', [tempName, '.set'], 'filepath', processedDatasets);


%% EVENT MODIFICATION

%% epoch


EEG = pop_epoch( EEG, bins2epoch, epochDuration, 'newname', tempName, 'epochinfo', 'yes');
%         EEG = pop_epochbin( EEG , epochDuration*1000,  'none'); % GUI: 06-Aug-2023 18:53:56
[ALLEEG, EEG, CURRENTSET] = eeg_store( ALLEEG, EEG, 0 );
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
EEG = eeg_checkset( EEG );


%% Interpolate bad channels and MANUAL TRIAL REJECTION
subjectName='G01S001'

[subjectProcessingDirectory,processedDatasets,eventsFolder,plotsFolder,csvTxtMatFiles,excelHist,...
    ERPsScalpPlots, ERPsLinePlots, PowerTFPlots, PowerScalpPlots, chanlocfile] = makeFolders(parent_Directory,subjectName);

preprocessedDataset = [subjectName, '_RemovedLineNoise.set'];
EEG = pop_loadset('filename', preprocessedDataset, 'filepath', processedDatasets);
[ALLEEG, EEG, CURRENTSET] = eeg_store(ALLEEG, EEG, 0);
pop_eegplot( EEG, 1, 1, 1);

%%
close
tempName = [subjectName, '_InterpolatedChan'];

chanName2interp={'T7','TP9','P8','TP10','Fp1','Fp2','AF7','TP8','AF8','P7','TP7','T8','O1','O2','Oz','P4','P8','PO7','PO8','PO4','PO3','P6','TP8','CP4'}
chanNo2Interp = arrayfun(@(x) find(strcmp({EEG.chanlocs.labels}, x)), chanName2interp);


EEG = pop_interp(EEG, chanNo2Interp, 'spherical');
EEG.comments = pop_comments(EEG.comments,'',['Interpolated ' strjoin(chanName2interp, ', ') ' channels.'],1);
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
[ALLEEG EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);
EEG = eeg_checkset( EEG );
close;
combinedInterpChanInfo = [chanName2interp', num2cell(chanNo2Interp')];
writecell(combinedInterpChanInfo, [eventsFolder 'interpolatedChan.txt'], 'FileType', 'text');

% average rereferencing
tempName = [subjectName, '_Avg_Rereferenced'];
EEG = pop_reref(EEG, []);
EEG = eeg_checkset(EEG);
[ALLEEG EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);
EEG.comments = pop_comments(EEG.comments,'','Channels are rereferenced.',1);

[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET, 'setname', tempName,'gui','off');
EEG = eeg_checkset( EEG );
pop_eegplot( EEG, 1, 1, 1);

%%
close all;
tempName=[subjectName,'_ManualTrialRej'];
EEG.comments = pop_comments(EEG.comments,'','Manual trial rejection.',1);
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
[ALLEEG, EEG, CURRENTSET] = eeg_store( ALLEEG, EEG, 0 );
EEG = eeg_checkset( EEG );
pop_saveset(EEG, 'filename', [tempName, '.set'], 'filepath', processedDatasets)
ALLEEG=[];EEG=[];



%% ICA
tempName = [subjectName, '_ICA_afterEpoching'];

% EEG = pop_runica_Modified(EEG, 'icatype', 'runica', 'extended',1,'interrupt','off');
EEG = pop_runica(EEG, 'icatype', 'runica', 'extended',1);
EEG = eeg_checkset( EEG );
[ALLEEG EEG] = eeg_store(ALLEEG, EEG, CURRENTSET);

[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
pop_saveset(EEG, 'filename', [tempName, '.set'], 'filepath', processedDatasets);

EEG = pop_iclabel(EEG, 'default');
% pop_selectcomps(EEG, [1:EEG.nbchan] );
EEG = eeg_checkset( EEG );

% Check for good or poor ICA decomposition Visually
pop_expica(EEG, 'weights', [csvTxtMatFiles,subjectName,'_1_ICAweightMatrixafterChanDeletion']);
pop_expica(EEG, 'inv', [csvTxtMatFiles,subjectName,'_2_ICAweightInverseMatrixafterChanDeletion']);


%% MANUAL COMPONENT REJECTION
subjectName ='AAT_G01S022_ActiChamp'

tempName = [subjectName, '_ICA_afterEpoching'];
subjectRawDataFolder = [parent_Directory, 'Raw_Data/', subjectName,'/'];
[subjectProcessingDirectory,processedDatasets,eventsFolder,plotsFolder,csvTxtMatFiles,excelHist,...
    ERPsScalpPlots, ERPsLinePlots, PowerTFPlots, PowerScalpPlots, chanlocfile] = makeFolders(parent_Directory,subjectName);


preprocessedDataset = [subjectName, '_ICA_afterEpoching.set'];
EEG = pop_loadset('filename', preprocessedDataset, 'filepath', processedDatasets);
[ALLEEG, EEG, CURRENTSET] = eeg_store(ALLEEG, EEG, 0);
%
pop_eegplot( EEG, 0, 1, 1);


%%

comp2remove=[1:8,12:17,19:31];

close all;
EEG = pop_subcomp( EEG, comp2remove, 0);

EEG.comments = pop_comments(EEG.comments,'',['ICA artifact rejection. ' num2str(comp2remove)],1);
[ALLEEG EEG CURRENTSET] = pop_newset(ALLEEG, EEG, CURRENTSET,'setname',tempName,'gui','off');
pop_saveset(EEG, 'filename', [tempName, '.set'], 'filepath', processedDatasets);
EEG = eeg_checkset( EEG );

ICsRemoved = mat2str(comp2remove);

subInfoUpdated = readtable(subInfoPath);
rowIndex = find(strcmp(subInfoUpdated.Subject, subjectName));

if isempty(rowIndex)
    error('Subject name not found in the table.');
else
    if isnumeric(subInfoUpdated.ICsRemoved) || islogical(subInfoUpdated.ICsRemoved)
        subInfoUpdated.ICsRemoved = arrayfun(@(x) num2str(x), subInfoUpdated.ICsRemoved, 'UniformOutput', false);
    end

    subInfoUpdated.ICsRemoved{rowIndex} = ICsRemoved;
    % Save the updated table back to the Excel file
    writetable(subInfoUpdated, subInfoPath);
    % Display message confirming save
    disp('Updated removed ICs in the Excel file.');
end

pop_eegplot(EEG, 1, 1, 1);

preprocessedDataset = [subjectName, '_PreProcessedDataset.set'];
pop_saveset(EEG, 'filename', preprocessedDataset, 'filepath', processedDatasets);
EEG = eeg_checkset( EEG );



            </pre>
         </ul>
      </p>

      <p>
         <ul>
            <li class="entry1">Get peak_amplitude, peak_latency, mean_amplitude, average_amplitude_around_peak, area_under_curve, and latency_50_percent.</li>
            <!-- R Code block -->
            <pre class="r-code">
      
ERPstart = ERPtimeWindows.ERP1startTime(ch);
ERPendTime = ERPtimeWindows.ERP1endTime(ch);

ERPname = 'ERP1';
[~, ERP1startColumnIndex] = min(abs(timepnts - ERPstart));
[~, ERP1endColumnIndex] = min(abs(timepnts - ERPendTime));

peakType = [];
peakType = ERPtimeWindows.ERP1PeakType{ch};
sampling_rate = 1000;                       % Sampling rate in Hz
n_points_around_peak = 50;                   % Number of points around the peak to average

if strcmp(ERPname, 'ERP2')
    ERP1startColumnIndex = ERP2startColumnIndex;
    ERP1endColumnIndex = ERP2endColumnIndex;

end

time_window_data = currentData(:, ERP1startColumnIndex:ERP1endColumnIndex);
time_window_vector = EEG.times(ERP1startColumnIndex:ERP1endColumnIndex);

% Find peaks based on the specified peak type
if strcmp(peakType, 'Negative')
    % For negative peaks, invert the signal
    [peaks, peak_indices] = findpeaks(-time_window_data);  % Invert to find negative peaks
    peaks = -peaks;  % Convert back to original values

    if isempty(peaks)
        peaks=min(time_window_data);
        peak_indices = find(time_window_data == peaks, 1);
    end
else
    % For positive peaks, find directly
    [peaks, peak_indices] = findpeaks(time_window_data);

    if isempty(peaks)
        peaks=max(time_window_data);
        peak_indices = find(time_window_data == peaks, 1);
    end
end

% Calculate the center index of the time window
center_index = round((ERP1startColumnIndex + ERP1endColumnIndex) / 2);

% Identify the peak nearest to the center
if isempty(peaks)
    error('No %s peaks found within the specified time window.', peakType);
end

if strcmp(peakType, 'Negative')
    % Find the index of the lowest value for negative peaks
    [~, peak_index] = min(peaks);
else
    % Find the index of the highest value for positive peaks
    [~, peak_index] = max(peaks);
end


% [~, closest_peak_idx] = min(abs(peak_indices + ERP1startColumnIndex - center_index));
main_peak_index = peak_indices(peak_index) + ERP1startColumnIndex;

new_window_start = ERP1startColumnIndex;  % Default to ERP1startColumnIndex
new_window_end = ERP1endColumnIndex;     % Default to ERP1endColumnIndex

% Search backwards for the last zero crossing before startSearchCol
for col = main_peak_index:-1:ERP1startColumnIndex + 1
    if (currentData(col) > 0 && currentData(col - 1) < 0) || (currentData(col) < 0 && currentData(col - 1) > 0)
        new_window_start = col;
        break;
    end
end

% Search forwards for the first zero crossing after startSearchCol
for col = main_peak_index:ERP1endColumnIndex - 1
    if (currentData(col) > 0 && currentData(col + 1) < 0) || (currentData(col) < 0 && currentData(col + 1) > 0)
        new_window_end = col;
        break;
    end
end


if new_window_start==new_window_end || new_window_end-new_window_start <=1
    new_window_start=new_window_start-10;
end

% Update time and data vectors for the final adjusted window around the main peak
adjusted_data = currentData(:, new_window_start:new_window_end);
adjusted_time_vector = EEG.times(new_window_start:new_window_end);

% Ensure only values of the selected type (positive or negative) are used for area calculation
if strcmp(peakType, 'Negative')
    adjusted_data(adjusted_data > 0) = 0;  % Set positive values to zero for negative area calculation
else
    adjusted_data(adjusted_data < 0) = 0;  % Set negative values to zero for positive area calculation
end

% Calculate Mean Amplitude for the adjusted window
mean_amplitude = mean(time_window_data);

% Calculate Area Under the Curve (AUC) within the adjusted window
area_under_curve = trapz(time_window_vector, time_window_data);

% Calculate cumulative area and find latency for 50% AUC
cumulative_area = cumtrapz(time_window_vector, time_window_data);
half_area_value = 0.5 * area_under_curve;

% Find the index where cumulative area reaches 50% of the total area
[~, idx_50_percent] = min(abs(cumulative_area - half_area_value));
latency_50_percent = time_window_vector(idx_50_percent);

% Calculate peak amplitude and latency
peak_amplitude = peaks(peak_index);  % Peak amplitude
peak_latency = EEG.times(main_peak_index);  % Peak latency in ms

% Calculate average amplitude around the main peak
avg_start_index = max(main_peak_index - n_points_around_peak, ERP1startColumnIndex);
avg_end_index = min(main_peak_index + n_points_around_peak, ERP1endColumnIndex);

% Use currentData to ensure we have the full range for averaging
average_amplitude_around_peak = mean(currentData(:, avg_start_index:avg_end_index), 2); % Average across channels


            </pre>
         </ul>
      </p>
      
      <hr style="border-top: 1px solid #ccc; margin: 5px 0;">
      
      <h1 class="ongoing_study_PMRFtitle"></h1>
      <div>
         <h3><strong>Power Analysis</strong></h3>
      </div>
      
      <p>
         <ul>
            <pre class="r-code">
      
               
% uiwait(msgbox('Select the Experiment folder'));
% main_directory = [uigetdir '/'];
% clear all;  clc;


% Check if a parallel pool is already open
% if isempty(gcp('nocreate'))
%     % Create a parallel pool with 8 workers
%     parpool(4);
% end

main_directory = 'F:\Experiments\02_Context_Experiment\';
% main_directory = '/Volumes/AVK_Seagate/Experiments/02_Context_Experiment/';


parent_Directory=[main_directory 'Context_EEG_datasets/'];
load([parent_Directory 'EEGchanlocs.mat'])

codepath = [parent_Directory, 'NewAnalysisScripts/'];
subfolders = genpath(parent_Directory);
addpath(parent_Directory);
addpath(subfolders);


[ALLEEG EEG CURRENTSET ALLCOM] = eeglab; close;
todaysDate = datestr(now, 'yyyy_mm_dd');


cycles{1}={6 12};
cycles{2}={6};
cycles{3}={8};
cycles{4}={10};
cycles{5}={12};

for pq = 1:size(cycles,2)

    range_cycles = cycles{pq};
    range_cycles = cell2mat(range_cycles);

    averagedMatrixAllGrp = cell(1000, 11);
    seMatrixAllGrp = cell(1000, 11);
    allGrpAllSubData = cell(1000, 14);

    grpDataCount=0;
    subDataCount=0;

    grps={'G01','G02','G03','G04','G05'};

    for y=1:length(grps)
        grp = grps{y};

        % Subject Info and Processed Behavioral DATA
        subInfoPath = [main_directory 'subInfo.csv'];
        subInfo = readtable(subInfoPath);

        subInfo=subInfo(strcmp(subInfo.grp, grp),:);

        if strcmp(grp,'G01')
            badData={'Context_G01S0001','Context_G01S0007','Context_G01S0012','Context_G01S0003','Context_G01S0004','Context_G01S0014'};
        elseif strcmp(grp,'G02')
            badData={'Context_G02S0001','Context_G02S0002','Context_G02S0009'};
        elseif strcmp(grp,'G03')
            badData={'Context_G03S0001','Context_G03S0004','Context_G03S0007'};
        elseif strcmp(grp,'G04')
            badData={'Context_G04S0001','Context_G04S0014'};
        elseif strcmp(grp,'G05')
            badData={'Context_G05S0007', 'Context_G05S0011'};
        end

        subInfo(ismember(subInfo.subID, badData), :) = [];
        channels2use={'C3','C4','F3','F4','P3','P4'};

        for lmn=1:length(channels2use)
            % for lmn=3

            % chani=CHANS2PLOT(lmn);
            AvgdDB = zeros(100,4500/2);
            allTempTF = cell(size(subInfo,1),1);
            subNum = 1:size(subInfo,1);
            %         subNum=6;
            for k=subNum

                grpnum = str2double(regexp(grp, '\d+', 'match', 'once'));

                updatedEventsBasedOnSessions=[1:19];
                relevantEvents= strcat('movementOnset', arrayfun(@num2str, updatedEventsBasedOnSessions, 'UniformOutput', false));

                bins2plot=[];
                if grpnum== 1 % No context
                    bins2plot=[1:9,16:18];
                elseif grpnum== 2 % context A, AB perturbation
                    bins2plot=[1:9,13:15];
                elseif grpnum== 3 % context B, AB perturbation
                    bins2plot=[1:9,10:12];
                elseif grpnum== 4 % context A
                    bins2plot=[1,3,7,8,9,13:15];

                elseif grpnum== 5 % context B
                    bins2plot=[1,2,4,5,6,10:12];
                end

                ALLEEG=[];

                subjectName=subInfo.subID{k}
                [subjectProcessingDirectory,processedDatasets,eventsFolder,plotsFolder,csvTxtMatFiles,excelHist,...
                    ERPsScalpPlots, ERPsLinePlots, PowerTFPlots, PowerScalpPlots, chanlocfile] = makeFolders(parent_Directory,subjectName);

                preprocessedDataset = [subjectName, '_PreProcessedDataset.set'];
                EEG = pop_loadset('filename', preprocessedDataset, 'filepath', processedDatasets);
                [ALLEEG, EEG, CURRENTSET] = eeg_store(ALLEEG, EEG, 0);

                [binIndices] = getBinIndices(EEG,(1:19),relevantEvents);
                binIndices_subset = binIndices(bins2plot, :);

                a=binIndices_subset';
                trialRange=a(2,:);
                eventsDetails = readtable(fullfile(parent_Directory, 'binEventList.txt'),'headerlines', 0);



                [chans, timepts, trials] = size(EEG.data);

                buffer_size = 500;

                % Initialize new data array with buffer added
                new_timepts = timepts + 2 * buffer_size; % new time points = original + 2*buffer
                extended_EEG_data = zeros(chans, new_timepts, trials);

                % Loop through each trial
                for trial = 1:trials
                    % Extract current trial data
                    current_data = EEG.data(:, :, trial);

                    % Reflect the start and end for buffer
                    reflected_start = flip(current_data(:, 1:buffer_size), 2); % reverse first 1500 points
                    reflected_end = flip(current_data(:, end-buffer_size+1:end), 2); % reverse last 1500 points

                    % Concatenate reflected start, original data, and reflected end
                    extended_EEG_data(:, :, trial) = [reflected_start, current_data, reflected_end];
                end

                %% define wavelet parameters: MorletWaveletConvolution

                % frequency parameters
                min_freq =  1;
                max_freq = 45;
                num_frex = max_freq-min_freq+1;
                frex = linspace((min_freq),(max_freq),num_frex);

                if length(range_cycles)==1
                    numcycles = 6 * ones(size(numcycles));
                else
                    numcycles=linspace((range_cycles(1)),(range_cycles(end)),num_frex);
                end

                wavtime = -2:1/EEG.srate:2;
                half_wave = (length(wavtime)-1)/2;


                % FFT parameters
                nWave = length(wavtime);
                nData = size(extended_EEG_data,2);
                nConv = nWave + nData - 1;


                chanOfInt={EEG.chanlocs.labels}';
                chanOfInt= chanOfInt(1:EEG.nbchan)';

                channelNumbers = find(ismember({EEG.chanlocs.labels}, chanOfInt));

                chanOfInt={EEG.chanlocs.labels}';
                channel2use=channels2use{lmn};
                chani = find(strcmp({EEG.chanlocs.labels}, channel2use));

                tf = zeros(length(frex),size(extended_EEG_data,2),EEG.trials);

                % loop over frequencies
                for fi=1:length(frex)
                    fi

                    % create wavelet and get its FFT
                    wavelet = exp(2*1i*pi*frex(fi).*wavtime) .* exp(-wavtime.^2./(2*(numcycles(fi)/(2*pi*frex(fi)))^2));
                    % wavelet = exp(2*1i*pi*frex(fi).*wavtime) .* exp(-wavtime.^2./(2*(12/(2*pi*frex(fi)))^2));
                    waveletX = fft(wavelet,nConv);
                    waveletX = waveletX ./ max(waveletX);

                    % now loop over trials...
                    for triali=1:EEG.trials
                        channel = channel2use;
                        chan = chani;
                        freq = fi;

                        dataX = fft(squeeze(extended_EEG_data(strcmpi(channel2use,{EEG.chanlocs.labels}),:,triali)), nConv);
                        % run convolution
                        as = ifft(waveletX .* dataX);
                        as = as(half_wave+1:end-half_wave);
                        tfRaw = abs(as).^2;

                        tf(fi,:,triali) = tfRaw;
                    end

                end

                tf = tf(:, buffer_size+1:end-buffer_size, :);

                trialRangeNew={};
                if ismember(grp, {'G01', 'G02', 'G03'})
                    trialRangeNew{1} = [trialRange{1} trialRange{2} trialRange{3}]
                    trialRangeNew{2} = [trialRange{4} trialRange{5} trialRange{6}]
                    trialRangeNew{3} = [trialRange{7} trialRange{8} trialRange{9}]
                    trialRangeNew{4} = [trialRange{10} trialRange{11} trialRange{12}]

                elseif ismember(grp, {'G04', 'G05'})
                    trialRangeNew={};
                    trialRangeNew{1} = [trialRange{1} trialRange{2}]
                    trialRangeNew{2} = [trialRange{3} trialRange{4} trialRange{5}]
                    trialRangeNew{3} = [trialRange{6} trialRange{7} trialRange{8}]
                end


                allEpochsinConditions={};
                for i=1:length(trialRangeNew)

                    currentRange = trialRangeNew{i};
                    matchingEpochs = [];
                    for binIndex = currentRange
                        rowIndex = find([EEG.event.bepoch] == binIndex);
                        if ~isempty(rowIndex)
                            matchingEpochs = [matchingEpochs, EEG.event(rowIndex).epoch];
                        end
                    end
                    selectedEpochs = unique(matchingEpochs);
                    allEpochsinConditions{i} = selectedEpochs;

                end

                if ismember(grp, {'G01', 'G02', 'G03'})
                    titles={'Baseline','Context B Perturbation', 'Context A Perturbation', 'Error Clamp'};
                elseif ismember(grp, {'G04'})
                    titles={'Baseline','Context A Perturbation', 'Error Clamp'};
                elseif ismember(grp, {'G05'})
                    titles={'Baseline','Context B Perturbation', 'Error Clamp'};
                end

                tempTF={};
                for x=1:length(allEpochsinConditions)

                    tfMean = mean(tf(:,:,allEpochsinConditions{x}),3);

                    baselinetime = [ -1400 2500 ]; % in ms
                    baselineidx=[];

                    % convert baseline window time to indices
                    [~,baselineidx(1)]=min(abs(EEG.times-baselinetime(1)));
                    [~,baselineidx(2)]=min(abs(EEG.times-baselinetime(2)));

                    % for whole experiment
                    tempRawPow = mean(tf(:,:,allEpochsinConditions{x}),3);
                    baseline_power = mean(tempRawPow(:,baselineidx(1):baselineidx(2)),2);


                    tempdb=10*log10(tempRawPow./baseline_power);
                    temppc=100*( tempRawPow-baseline_power)./ baseline_power;

                    % plotCount=plotCount+1;
                    %
                    % subplot(2,2,plotCount)
                    % contourf(EEG.times, min_freq:max_freq, tempdb(min_freq:max_freq,:), 100, 'linecolor', 'none');
                    % caxis([-3 3]);
                    % set(gca, 'ydir', 'normal', 'xlim', [-1500 2900],'ylim',[min_freq, max_freq]);
                    % colormap('jet')
                    % colorbar;
                    % title(['DB'  '\_' titles{x}])
                    % sgtitle([grp ': ' EEG.chanlocs(chani).labels ' Chan Plot; ' strrep(subjectName, '_', '\_')])

                    % ADD VARIABLE NAMES
                    tempTF{1,1}=grp;
                    tempTF{1,2}=subjectName;
                    tempTF{1,3}=EEG.chanlocs(chani).labels;
                    tempTF{1,4}=allEpochsinConditions;
                    tempTF{1,5}=tf;
                    %                 tempTF{1,bins2plot(x)+5}=tempdb;
                    %                 tempTF{1,bins2plot(x)+5+length(trialRangeNew)}=temppc;
                    tempTF{1,x+5}=tempdb;
                    tempTF{1,x+5+length(trialRangeNew)}=temppc;


                end

                % set(gcf, 'PaperUnits', 'inches');
                % set(gcf, 'PaperSize', [20, 15]);  % Set width AND height
                % print('-dpdf', [main_directory 'Context_EEG_datasets/splServerPLots/avgdTF_' subjectName '_' EEG.chanlocs(chani).labels]);  % Replace 'filename.pdf' with your desired filename
                %
                % close;

                allTempTF{k} = tempTF;

            end

            %% POOL ALL SUBJECTS IN A GROUP

            % appendStr = ['baseline ' num2str(baselinetime(1)), ' to ', num2str(baselinetime(2)), '_cycles ', num2str(range_cycles), '_date ', todaysDate];
            allSubData = [];

            for ki = subNum
                if ~isempty(allTempTF{ki, 1})
                    rowVector = allTempTF{ki, 1}(:)';
                    % rowVector(end+1)={appendStr};

                    allSubData = [allSubData; rowVector];
                else
                    break;
                end
            end

            %% AVERAGE ALL SUBJECTS IN A GROUP
            numRows = size(allSubData, 1);
            numCols = size(allSubData, 2);

            % Initialize the averagedMatrix with the first two columns
            averagedMatrix = {allSubData{1, 1}, allSubData{1, 3}};
            seMatrix = {}; % Initialize matrix to store SE values

            for yz = 6:numCols
                sumMatrix = zeros(size(allSubData{1, yz}));
                sumSqMatrix = zeros(size(allSubData{1, yz})); % For SE calculation

                % Sum across rows
                for xy = 1:numRows
                    if ~isempty(allSubData{xy, yz})
                        sumMatrix = sumMatrix + allSubData{xy, yz};
                        sumSqMatrix = sumSqMatrix + allSubData{xy, yz}.^2;
                    end
                end

                % Average the matrix and store in averagedMatrix
                averagedMatrix{1, yz-3} = sumMatrix ./ numRows;

                % Calculate Standard Error (SE)
                variance = (sumSqMatrix - (sumMatrix.^2) ./ numRows) ./ (numRows - 1);
                seMatrix{1, yz-3} = sqrt(variance ./ numRows);
            end
            %% plot

            load([main_directory 'Context_EEG_datasets/timePnts.mat'])
            % timePnts=EEG.data;

            if ismember(grp, {'G01', 'G02', 'G03'})
                numSubPLot=4;
                titles={'Baseline','Context B Perturbation', 'Context A Perturbation', 'Error Clamp'};
            elseif ismember(grp, {'G04'})
                numSubPLot=3;
                titles={'Baseline','Context A Perturbation', 'Error Clamp'};
            elseif ismember(grp, {'G05'})
                numSubPLot=3;
                titles={'Baseline','Context B Perturbation', 'Error Clamp'};
            end

            figure('Units', 'normalized', 'Position', [0, 0, 1, 1]);

            for xyz=1:numSubPLot
                subplot(2,2,xyz)
                data2plotDB=averagedMatrix{1, xyz+2};

                contourf(EEG.times, min_freq:max_freq, data2plotDB(:,:), 100, 'linecolor', 'none');
                clim([-2 2]);
                set(gca, 'ydir', 'normal', 'xlim', [-1500 2900],'ylim',[min_freq, max_freq]);
                colormap('jet')
                colorbar;
                title(['DB plot: ' titles{xyz}])
                sgtitle(['Averaged DB ' grp] )
            end

            set(gcf, 'PaperUnits', 'inches');
            set(gcf, 'PaperSize', [20, 15]);  % Set width AND height
            print('-dpdf', [main_directory 'Context_EEG_datasets/splServerPLots/avgd_DB_' grp '_' channel2use]);  % Replace 'filename.pdf' with your desired filename
            close


            %% PC
            figure('Units', 'normalized', 'Position', [0, 0, 1, 1]);

            if ismember(grp, {'G01', 'G02', 'G03'})

                colforward=6;

            else
                colforward=5;
            end

            for xyz=1:numSubPLot
                subplot(2,2,xyz)
                data2plotDB=averagedMatrix{1, xyz+colforward};

                contourf(EEG.times, min_freq:max_freq, data2plotDB(:,:), 100, 'linecolor', 'none');
                clim([-30 30]);
                set(gca, 'ydir', 'normal', 'xlim', [-1500 2900],'ylim',[min_freq, max_freq]);
                colormap('jet')
                colorbar;
                title(['PC plot: ' titles{xyz}])
                sgtitle(['Averaged PC ' grp] )
            end

            set(gcf, 'PaperUnits', 'inches');
            set(gcf, 'PaperSize', [20, 15]);  % Set width AND height
            print('-dpdf', [main_directory 'Context_EEG_datasets/splServerPLots/avgd_PC_' grp '_' channel2use]);  % Replace 'filename.pdf' with your desired filename
            close
            %%        % beta band

            figure('Units', 'normalized', 'Position', [0, 0, 1, 1]);
            beta = [13 30]; % Frequency range for beta

            % Initialize an array to store plot handles for the legend
            plotHandles = [];

            for xyz = 1:numSubPLot
                hold on
                data2plotDB = averagedMatrix{1, xyz+2};
                data2plotDB = mean(data2plotDB(beta(1):beta(2),:), 1);

                % Calculate SE
                seData = mean(seMatrix{1, xyz+2}(beta(1):beta(2),:), 1);

                % Plot the data line and store the handle
                h = plot(EEG.times, data2plotDB(:,:), 'LineWidth', 2);
                plotHandles(xyz) = h;  % Store handle for legends
                lineColor = get(h, 'Color'); % Get line color to match SE fill

                % Plot SE as shaded region, matching the line color
                fill([EEG.times, fliplr(EEG.times)], ...
                    [data2plotDB + seData, fliplr(data2plotDB - seData)], ...
                    lineColor, 'FaceAlpha', 0.2, 'EdgeColor', 'none'); % Reduced opacity

                % Add vertical and horizontal lines
                xline(0, "LineStyle", "--", 'HandleVisibility', 'off');
                yline(0, "LineStyle", "--", 'HandleVisibility', 'off');
                set(gca, 'ydir', 'normal', 'xlim', [-1500 2900], 'ylim', [-3 3]);
            end

            % Add legends for conditions (only the lines)
            legend(plotHandles, titles, 'Location', 'bestoutside'); % Use handles for lines only, SE excluded

            % Super title for all subplots
            sgtitle(['Averaged DB ' grp]);


            set(gcf, 'PaperUnits', 'inches');
            set(gcf, 'PaperSize', [20, 15]);  % Set width AND height
            print('-dpdf', [main_directory 'Context_EEG_datasets/splServerPLots/avgd_DB_betaBand_' grp '_' channel2use]);  % Replace 'filename.pdf' with your desired filename
            close


            %%
            figure('Units', 'normalized', 'Position', [0, 0, 1, 1]);
            beta = [13 30]; % Frequency range for beta

            % Initialize an array to store plot handles for the legend
            plotHandles = [];

            for xyz = 1:numSubPLot
                hold on
                data2plotDB = averagedMatrix{1, xyz+colforward};
                data2plotDB = mean(data2plotDB(beta(1):beta(2),:), 1);

                % Calculate SE
                seData = mean(seMatrix{1, xyz+colforward}(beta(1):beta(2),:), 1);

                % Plot the data line and store the handle
                h = plot(EEG.times, data2plotDB(:,:), 'LineWidth', 2);
                plotHandles(xyz) = h;  % Store handle for legends
                lineColor = get(h, 'Color'); % Get line color to match SE fill

                % Plot SE as shaded region, matching the line color
                fill([EEG.times, fliplr(EEG.times)], ...
                    [data2plotDB + seData, fliplr(data2plotDB - seData)], ...
                    lineColor, 'FaceAlpha', 0.2, 'EdgeColor', 'none'); % Reduced opacity

                % Add vertical and horizontal lines
                xline(0, "LineStyle", "--", 'HandleVisibility', 'off');
                yline(0, "LineStyle", "--", 'HandleVisibility', 'off');
                set(gca, 'ydir', 'normal', 'xlim', [-1500 2900], 'ylim', [-50 50]);
            end

            % Add legends for conditions (only the lines)
            legend(plotHandles, titles, 'Location', 'bestoutside'); % Use handles for lines only, SE excluded

            % Super title for all subplots
            sgtitle(['Averaged PC ' grp]);


            set(gcf, 'PaperUnits', 'inches');
            set(gcf, 'PaperSize', [20, 15]);  % Set width AND height
            print('-dpdf', [main_directory 'Context_EEG_datasets/splServerPLots/avgd_PC_betaBand_' grp '_' channel2use]);  % Replace 'filename.pdf' with your desired filename
            close

            %% Combine PDFs
            inputDir = [main_directory 'Context_EEG_datasets/splServerPLots/'];


            outputFileName = [main_directory 'Context_EEG_datasets/splServerPLots/combinedPLots/' grp '_' channel2use '_baseline_' ...
                num2str(baselinetime(1)) 'to' num2str(baselinetime(2)) ...
                '_cycles_' num2str(range_cycles) ...
                '_' todaysDate '.pdf'];

            % Get all PDF files in the directory
            pdfFiles = dir(fullfile(inputDir, '*.pdf'));
            pdfFileNames = fullfile({pdfFiles.folder}, {pdfFiles.name}); % Full paths of PDFs

            mergePdfs(pdfFileNames, outputFileName);
            cellfun(@delete, pdfFileNames);

            close all;

            if ismember(grp, {'G01', 'G02', 'G03'})
                col2save1=[3:6];
                col2save2=[7:10];
                col2avg=[3:10];
            elseif ismember(grp, {'G04'})
                col2save1=[3,5,6];
                col2save2=[7,9,10];
                col2avg=[3:8];
            elseif ismember(grp, {'G05'})
                col2save1=[3,4,6];
                col2save2=[7,8,10];
                col2avg=[3:8];
            end

            col2save=[col2save1 col2save2];

            grpDataCount=grpDataCount+1;
            appendStr = ['baseline ' num2str(baselinetime(1)), ' to ', num2str(baselinetime(2)), '_cycles ', num2str(range_cycles), '_date ', todaysDate];

            % Append the new column to each row of averagedMatrixAllGrp

            for i = 1:length(averagedMatrix)
                averagedMatrixAllGrp(grpDataCount, 1:2) = averagedMatrix(1:2); % Copy first two columns directly
                averagedMatrixAllGrp(grpDataCount, col2save) = averagedMatrix(col2avg); % Assign the remaining values based on col2save
                averagedMatrixAllGrp(grpDataCount, 11) = {appendStr};

                seMatrixAllGrp(grpDataCount, 1:2) = averagedMatrix(1:2); % Copy first two columns directly
                seMatrixAllGrp(grpDataCount, col2save) = seMatrix(col2avg); % Assign the remaining values based on col2save
                seMatrixAllGrp(grpDataCount, 11) = {appendStr};

                allSubData = [allSubData, cell(size(allSubData, 1), (size(allGrpAllSubData,2)-size(allSubData,2)))];  % Adds 2 empty columns

                allGrpAllSubData = [allGrpAllSubData;allSubData];


            end
            allGrpAllSubData = [allGrpAllSubData, repmat({appendStr}, size(allGrpAllSubData, 1), 1)];

            % for i = 1:length(averagedMatrix)
            %     averagedMatrixAllGrp{y,1} = averagedMatrix{1};
            %     averagedMatrixAllGrp{y,2} = averagedMatrix{2};
            %     averagedMatrixAllGrp{y,[col2save1 col2save2]} = averagedMatrix{3:end};  % Assign each element of averagedMatrix to a new cell
            %     seMatrixAllGrp{y,i} = seMatrix{i};  % Assign each element of averagedMatrix to a new cell
            % end
        end
    end

    % Close the parallel pool when done
    % if ~isempty(gcp('nocreate'))
    %     delete(gcp('nocreate'));  % Close the parallel pool
    % end


    %% DB GROUPS COMBINED
    % Load necessary variables and define the figure layout
    titles = {'Baseline', 'Context B Perturbation', 'Context A Perturbation', 'Error Clamp'};
    numSubPLot=4;

    beta = [13 30];  % Frequency range for beta

    % Define color map for each group
    colorMap = containers.Map({'G01', 'G02', 'G03', 'G04', 'G05'}, ...
        {[0.4940 0.1840 0.5560], [0.4660 0.6740 0.1880], [0 0.4470 0.7410], ...
        [0.8500 0.3250 0.0980], [0.9290 0.6940 0.1250]});

    figure('Units', 'normalized', 'Position', [0, 0, 1, 1]);

    for xyz = 1:numSubPLot
        subplot(2, 2, xyz);
        hold on;

        % Initialize containers for plot handles and titles for the legend
        plotHandles = [];
        allTitles = {};

        for m = 1:length(grps)
            currGrp = grps{m};

            % Assign titlesContext based on group
            switch currGrp
                case 'G01'
                    titlesContext={' A+B+No Baseline',' B Perturbation', ' A Perturbation', ' No Context Error Clamp'};
                case 'G02'
                    titlesContext={' A+B+No Baseline',' B Perturbation', ' A Perturbation', ' A Context Error Clamp'};
                case 'G03'
                    titlesContext = {'A+B+No Baseline', 'B Perturbation', 'A Perturbation', 'B Context Error Clamp'};
                case 'G04'
                    titlesContext = {'A+No Baseline', '', 'A Perturbation', 'A Context Error Clamp'};
                case 'G05'
                    titlesContext = {'B+No Baseline', 'B Perturbation','', 'B Context Error Clamp'};
            end

            % Retrieve data for the current subplot
            currAvgMat = averagedMatrixAllGrp(m, :);
            currSEmat = seMatrixAllGrp(m, :);

            data2plotDB = currAvgMat{1, xyz+2};
            % figure
            % Plot if data is available
            if ~isempty(data2plotDB)
                % Calculate the mean data in the beta range and the standard error
                data2plotDB = mean(data2plotDB(beta(1):beta(2), :), 1);
                seData = mean(currSEmat{1, xyz+2}(beta(1):beta(2), :), 1);

                % Plot data with assigned color for each group
                h = plot(EEG.times, data2plotDB, 'LineWidth', 2, 'Color', colorMap(currGrp));
                plotHandles = [plotHandles h];  % Append handle for legend

                % Shaded area for SE
                lineColor = get(h, 'Color');  % Color for SE fill
                fill([EEG.times, fliplr(EEG.times)], ...
                    [data2plotDB + seData, fliplr(data2plotDB - seData)], ...
                    lineColor, 'FaceAlpha', 0.2, 'EdgeColor', 'none');

                % Add title to allTitles array
                allTitles = [allTitles, {[currGrp ' - ' titlesContext{xyz}]}];
            end
        end

        % Add vertical and horizontal lines
        xline(0, "LineStyle", "--", 'HandleVisibility', 'off');
        yline(0, "LineStyle", "--", 'HandleVisibility', 'off');
        set(gca, 'ydir', 'normal', 'xlim', [-1500 2900], 'ylim', [-2 2]);

        % Set title and legend for the current subplot
        title(titles{xyz});
        if ~isempty(plotHandles)
            legend(plotHandles, allTitles, 'Location', 'best');
        end
    end

    % Super title for all subplots
    sgtitle(['Averaged Beta Band - DB - All Groups']);

    % Print the figure if needed
    set(gcf, 'PaperUnits', 'inches');
    set(gcf, 'PaperSize', [20, 15]);  % Set width AND height

    outputFileName1 = [main_directory 'Context_EEG_datasets/splServerPLots/combinedPLots/' 'All_Grps_' channel2use '_baseline_'  ...
        num2str(baselinetime(1)) 'to' num2str(baselinetime(2)) ...
        '_cycles_' num2str(range_cycles) ...
        '_' todaysDate '_.pdf'];


    print('-dpdf', outputFileName1);  % Save as PDF
    close;


    %%
    % Define the save path
    savePath = [main_directory 'Context_EEG_datasets/splServerPlots/tempMatFiles'];

    averagedMatrixAllGrp = averagedMatrixAllGrp(~cellfun(@(x) isempty(x), averagedMatrixAllGrp(:, 3)), :);
    seMatrixAllGrp = seMatrixAllGrp(~cellfun(@(x) isempty(x), seMatrixAllGrp(:, 3)), :);
    allGrpAllSubData = allGrpAllSubData(~cellfun(@(x) isempty(x), allGrpAllSubData(:, 3)), :);

    % Save averagedMatrixAllGrp and seMatrixAllGrp as .mat files
    save(fullfile(savePath, ['All_Grps_' channel2use '_baseline_'  ...
        num2str(baselinetime(1)) 'to' num2str(baselinetime(2)) ...
        '_cycles_' num2str(range_cycles) ...
        '_' todaysDate '_averagedMatrixAllGrp.mat']), 'averagedMatrixAllGrp', '-v7.3');

    save(fullfile(savePath, ['All_Grps_' channel2use '_baseline_'  ...
        num2str(baselinetime(1)) 'to' num2str(baselinetime(2)) ...
        '_cycles_' num2str(range_cycles) ...
        '_' todaysDate '_seMatrixAllGrp.mat']), 'seMatrixAllGrp', '-v7.3');

    % save(fullfile(savePath, ['All_Grps_' channel2use '_baseline_'  ...
    %     num2str(baselinetime(1)) 'to' num2str(baselinetime(2)) ...
    %     '_cycles_' num2str(range_cycles) ...
    %     '_' todaysDate 'allGrpAllSubData.mat']), 'allGrpAllSubData', '-v7.3');

    averagedMatrixAllGrp=[];
    seMatrixAllGrp=[];
    allGrpAllSubData=[];
    ALLEEG=[];
    range_cycles=[];
    baselinetime=[];
    channel2use=[];


    % fprintf('Files saved to %s\n', savePath);

end

               
                           </pre>
         </ul>
      </p>
      
      <hr style="border-top: 1px solid #ccc; margin: 5px 0;">
      


       
      <h1 class="ongoing_study_PMRFtitle"></h1>
      <div>
         <h3><strong>TopoPlots and GIF</strong></h3>
      </div>
      
      <p>
         <ul>
            <pre class="r-code">
      
               % clear all; close all; clc;							%clear command window matlab

               %% Prepare the directories and initiate required variables
               % Context_G01S0002
               % uiwait(msgbox('Select the Experiment folder'));
               main_directory = [uigetdir '/'];
               parent_Directory=[main_directory 'Context_EEG_datasets/'];
               
               codepath = [parent_Directory, 'Analysis_Script/'];
               subfolders = genpath(parent_Directory);
               addpath(parent_Directory);
               addpath(subfolders);
               
               % Subject Info and Processed Behavioral DATA
               subInfoPath = [main_directory 'subInfo.csv'];
               subInfo = readtable(subInfoPath);
               subInfo = subInfo(strcmp(subInfo.EEGanalysis, 'Yes'),:);
               chanlocsData= load([parent_Directory 'EEGchanlocs.mat']);
               
               load([parent_Directory,'timePnts.mat'])
               
               chanOfInt={chanlocsData.chanlocsData.labels}';
               allGrps = unique(subInfo.grp);
               
               
               bins2plotGrp1=[1:9,16:18];
               bins2plotGrp2=[1:9,13:15];
               bins2plotGrp3=[1:9,10:12];
               bins2plotGrp4=[1,3,7,8,9,13:15];
               bins2plotGrp5=[1,2,4,5,6,10:12];
               
               binsAll{1,1}=1;binsAll{1,2}=bins2plotGrp1;
               binsAll{2,1}=2;binsAll{2,2}=bins2plotGrp2;
               binsAll{3,1}=3;binsAll{3,2}=bins2plotGrp3;
               binsAll{4,1}=4;binsAll{4,2}=bins2plotGrp4;
               binsAll{5,1}=5;binsAll{5,2}=bins2plotGrp5;
               
               binNames=readtable([parent_Directory,'binEventList.txt']);
               binNames=binNames{1:end-1,end}';
               
               
               load([parent_Directory 'avgdGrpData/avgdERPdata.mat']);
               load([parent_Directory 'avgdGrpData/avgdBetaPCdata.mat']);
               
               %%
               data2plot = avgdBetaPCdata;
               for k=1:length(allGrps)
                   % topoPlotERPdata = topoPlotData(strcmp(topoPlotData.group, allGrps{k}) & strcmp(topoPlotData.dataType, 'erp'),:);
               
                   bins2plot = binsAll{k,2};
                   colNames = binNames(bins2plot);
                   clear j
                   for j=1:numel(colNames)
               
                       % erpTab2Plot = erpTab(strcmp(erpTab{:,1}, allGrps{k}) & strcmp(erpTab{:,2}, colNames{j}),:);
               
               
                       grpIdx = strcmp(data2plot(:, 1), allGrps{k});  % Find rows where first column matches allGrps{k}
                       condIdx = strcmp(data2plot(:, 2), colNames{j});  % Find rows where second column matches 'Baseline_No_Context'
               
                       % Combine indices using element-wise AND (&)
                       filterIdx = grpIdx & condIdx;
               
                       % Append filtered rows to erpTab2Plot
                       erpTab2Plot = data2plot(filterIdx, :);
               
               
               
                       timePoints2plot = -50:50:2000;  % Time points to plot (adjust as needed)
                       numSubPlots = numel(timePoints2plot);
               
                       fig1 = figure;
                       fig1.Position = [10 10 1920 1080];
               
                       for l = 1:numel(timePoints2plot)
                           [~, timeIdx] = min(abs(timePnts - timePoints2plot(l)));
                           subplot(6,7,l)
                           % Plot ERP topoplot for the corresponding time point
                           topoplot(cell2mat(erpTab2Plot(:, timeIdx+5)), chanlocsData.chanlocsData, 'maplimits',[-025 025], 'electrodes','off', 'style','map');
                           title([num2str(timePoints2plot(l)) 'ms' ]);  % Adjust title as needed
                           % colorbar;
               
                       end
               
                       sgtitle([allGrps{k} ' - ' colNames{j}], 'Interpreter', 'none');  % 'Interpreter', 'none' to avoid interpreting underscores
               
                       set(gcf, 'PaperUnits', 'inches');
                       set(gcf, 'PaperSize', [20, 15]);  % Set width AND height
                       print('-dpdf', [parent_Directory 'grpPlots/topoPlots/' allGrps{k} '_' colNames{j} '.pdf']);
                       close all;
               
                   end
               end
               % % Adjust figure properties if needed
               % set(gcf, 'Position', [100, 100, 1200, 600]);
               %%
               
               
               
               
               %% GIF
               
               load([parent_Directory 'avgdGrpData/topoPlotData.mat'])
               %%
               clc
               imgTimeGap=20;
               
               
               % dataType = {'erp', 'pc'};
               dataType = {'pc'};
               
               
               for pqr = 1:length(dataType)
               
                   for k=1:length(allGrps)
                       topoPlotERPdata = topoPlotData(strcmp(topoPlotData.group, allGrps{k}) & strcmp(topoPlotData.dataType, dataType{pqr}),:);
               
               
               
                       %% average beta band
               
                       if strcmp(dataType{pqr},'pc')
               
                           mapLim = [-25 25];
                           gifnamePart= [dataType{pqr} 'Topoplot_beta_'];
                           % Create an empty table to store the results
                           newTable = topoPlotERPdata(:, 1:3); % Keep the first 3 columns as they are
               
                           % Get the number of rows and columns in the original table
                           [numRows, numCols] = size(topoPlotERPdata);
               
                           % Iterate over each cell from the 4th column onwards
                           for col = 4:numCols
                               newColData = cell(numRows, 1);
                               for row = 1:numRows
                                   % Extract the 31x4100 matrix from the current cell
                                   currentMatrix = topoPlotERPdata{row, col};
                                   currentMatrix=currentMatrix{1};
               
                                   % Average the 9th to 21st rows
                                   if ~isempty(currentMatrix)
                                       averagedData = mean(currentMatrix(9:21, :), 1);
                                   else
                                       averagedData=[];
                                   end
               
                                   % Store the averaged data in the new table's cell
                                   newColData{row} = averagedData;
                               end
                               % Append the new column of averaged data to the new table
                               % newTable = [newTable, table(newColData)];
                               newColName = ['AveragedCol', num2str(col-3)];
                               newTable.(newColName) = newColData;
                           end
                           topoPlotERPdata{:,:}=newTable{:,:};
               
                       else
               
                           gifnamePart= [dataType{pqr} 'Topoplot_'];
                           mapLim = [-3 3];
               
                       end
               
                       %%
               
                       currGrp = allGrps{k,1};
               
                       currBins = binsAll{k,2};
               
                       for bin = 1:length(currBins)
               
                           currBin = currBins(bin);
                           currBinName = binNames{currBin};
               
                           wideTable=[];
               
                           for i=1:height(topoPlotERPdata)
                               abc = topoPlotERPdata{i,currBin+3}; abc=abc{1};
                               wideTable(i,:) =abc;
                           end
               
               
               
               
                           % wideTable=[];
                           % for i=1:height(topoPlotERPdata)
                           %     wideTable(i,:) =topoPlotERPdata.Baseline_No_Context{i};
                           %
                           % end
               
               
                           % Example assuming wideTable and chanlocsData are defined appropriately
                           % Replace with your actual data and channel locations
               
                           % Initialize variables
                           fig1 = figure;
                           fig1.Position = [10 10 750 750];
                           numDataPnts = size(wideTable, 2);  % Number of data points (frames) in wideTable
               
                           timePoints2plot = -100:imgTimeGap:2000;  % Time points to plot (adjust as needed)
                           frames = cell(1, numel(timePoints2plot));
               
                           a=[gifnamePart currGrp '_' currBinName ];
                           a=strrep(a, '_', '-');
                           
                           % Loop through each time point
                           for j = 1:numel(timePoints2plot)
                               % Find the corresponding index in timePnts closest to timePoints2plot(j)
                               [~, timeIdx] = min(abs(timePnts - timePoints2plot(j)));
               
                               % Plot ERP topoplot for the corresponding time point
                               topoplot(wideTable(:, timeIdx), chanlocsData.chanlocsData, 'maplimits',mapLim, 'electrodes','on', 'style','map');
                               title([num2str(timePoints2plot(j)) 'ms' ]);  % Adjust title as needed
               
               
                               sgtitle(a)
                               colorbar;
                               set(findall(gcf, 'type', 'text'), 'Color', 'k');
                               frames{j} = getframe(gcf);  % Capture the current frame
                               pause(0.05);  % Optional: Pause to see the plot (adjust as needed)
                               clf;  % Clear current figure for the next plot
                           end
               
               
                           % Create GIF animation
                           fileName = [parent_Directory 'grpPlots/gif/' gifnamePart currGrp '_' currBinName '.gif'];
                           for k = 1:numel(frames)
                               [A, map] = rgb2ind(frames{k}.cdata, 256);
                               if k == 1
                                   imwrite(A, map, fileName, 'gif', 'LoopCount', Inf, 'DelayTime', 0.1);
                               else
                                   imwrite(A, map, fileName, 'gif', 'WriteMode', 'append', 'DelayTime', 0.1);
                               end
                           end
               
                           % Close the figure
                           close(gcf);
                           close all;
                       end
                   end
               
               end
               % Message indicating GIF creation
               disp('GIF animation created successfully.');
               
               
                           </pre>
         </ul>
      </p>
      
      <hr style="border-top: 1px solid #ccc; margin: 5px 0;">
      
      
         
      <h1 class="ongoing_study_PMRFtitle"></h1>
      <div>
         <h3><strong>Merge PDFs</strong></h3>
      </div>
      
      <p>
         <ul>
            <pre class="r-code">
      
function mergePdfs(fileNames, outputFile)

memSet = org.apache.pdfbox.io.MemoryUsageSetting.setupMainMemoryOnly();
merger = org.apache.pdfbox.multipdf.PDFMergerUtility;

cellfun(@(f) merger.addSource(f), fileNames)

merger.setDestinationFileName(outputFile)
merger.mergeDocuments(memSet)
end

%% USAGE
            inputDir = [main_directory 'Context_EEG_datasets/splServerPLots/'];


            outputFileName = [main_directory 'Context_EEG_datasets/splServerPLots/combinedPLots/' grp '_' channel2use '_baseline_' ...
                num2str(baselinetime(1)) 'to' num2str(baselinetime(2)) ...
                '_cycles_' num2str(range_cycles) ...
                '_' todaysDate '.pdf'];

            % Get all PDF files in the directory
            pdfFiles = dir(fullfile(inputDir, '*.pdf'));
            pdfFileNames = fullfile({pdfFiles.folder}, {pdfFiles.name}); % Full paths of PDFs

            mergePdfs(pdfFileNames, outputFileName);
            cellfun(@delete, pdfFileNames);

            close all;
               
                           </pre>
         </ul>
      </p>
      
      <hr style="border-top: 1px solid #ccc; margin: 5px 0;">
      
      

      <div>
         <h1 class="ongoing_study_PMRFtitle"></h1>
         <div class="blog_section layout_padding">
            <div class="container">
               <div class="row">
                  <div class="col-md-12">
                  </div>
               </div>
            </div>
         </div>
      </div>
      




<!-- Custom CSS for styling -->
<style>
   .r-code {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      text-align: left; /* Align code to the left */
   }

   /* Styling for comments in R code */
   .r-code span.comment {
      color: green; /* Color for comments */
   }

   /* Match R comments and apply styles */
   .r-code {
      white-space: pre-wrap;
      word-wrap: break-word;
   }

   .r-code code {
      display: inline;
   }
</style>



      <!-- copyright section start -->
      <style>
         .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #2e2e2e;
            color: white;
            text-align: center;
            padding: 15px;
            /* Add padding for spacing */
         }

         .copyright_text {
            margin: 0;
            /* Remove default margin */
         }
      </style>

      <div class="footer">
         <div class="container">
            <p class="copyright_text">Copyright © 2024. Adarsh K. Verma. All right reserved.</p>
         </div>
      </div>

      <!-- copyright section end -->

      <!-- copyright section end -->
      <!-- Javascript files-->
      <script src="js/jquery.min.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.bundle.min.js"></script>
      <script src="js/jquery-3.0.0.min.js"></script>
      <script src="js/plugin.js"></script>
      <!-- sidebar -->
      <script src="js/jquery.mCustomScrollbar.concat.min.js"></script>
      <script src="js/custom.js"></script>
      <!-- javascript -->
</body>

</html>